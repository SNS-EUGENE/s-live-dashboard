<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>S-LIVE 스튜디오 기능 무결성 검사</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; padding: 20px; background-color: #f4f7f9; }
        .container { max-width: 800px; margin: 0 auto; background: #fff; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); padding: 20px 40px; }
        h1, h2 { border-bottom: 2px solid #eee; padding-bottom: 10px; color: #333; }
        .test-group { margin-bottom: 30px; }
        .test-item { display: flex; align-items: center; padding: 12px; border: 1px solid #ddd; border-radius: 6px; margin-bottom: 10px; transition: all 0.2s; }
        .test-item-title { font-weight: 600; flex-basis: 250px; }
        .test-item-result { flex-grow: 1; font-family: "SFMono-Regular", Consolas, "Liberation Mono", Menlo, monospace; }
        .status { padding: 4px 8px; border-radius: 4px; color: #fff; font-weight: bold; }
        .status.pass { background-color: #28a745; }
        .status.fail { background-color: #dc3545; }
        .status.neutral { background-color: #6c757d; }
        .status.info { background-color: #17a2b8;}
        button { padding: 10px 15px; border: none; border-radius: 5px; color: white; cursor: pointer; font-size: 14px; margin-right: 10px;}
        .btn-primary { background-color: #007bff; }
        .btn-success { background-color: #28a745; }
        .btn-danger { background-color: #dc3545; }
        .btn-info { background-color: #17a2b8; }
        input { padding: 10px; border-radius: 5px; border: 1px solid #ccc; margin-right: 10px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>S-LIVE 스튜디오 기능 무결성 검사</h1>
        <p>이 페이지는 각 기능들이 정상적으로 작동하는지 확인하기 위한 진단 도구입니다.</p>
        <button class="btn-primary" onclick="runAllTests()">모든 검사 실행</button>
        
        <div class="test-group">
            <h2>1. 기본 환경 검사</h2>
            <div class="test-item">
                <div class="test-item-title">Firebase Config 로드</div>
                <div class="test-item-result" id="test-firebase-config">대기중...</div>
            </div>
            <div class="test-item">
                <div class="test-item-title">JS 파일 로드 (공통)</div>
                <div class="test-item-result" id="test-common-js">대기중...</div>
            </div>
            <div class="test-item">
                <div class="test-item-title">JS 파일 로드 (페이지)</div>
                <div class="test-item-result" id="test-page-js">대기중...</div>
            </div>
        </div>

        <div class="test-group">
            <h2>2. Firebase 인증 검사</h2>
            <div class="test-item">
                <div class="test-item-title">현재 로그인 상태</div>
                <div class="test-item-result" id="test-auth-status">확인 중...</div>
            </div>
            <div>
                <input type="email" id="test-email" placeholder="관리자 이메일">
                <input type="password" id="test-password" placeholder="관리자 비밀번호">
                <button class="btn-success" onclick="testLogin()">테스트 로그인</button>
                <button class="btn-danger" onclick="testLogout()">테스트 로그아웃</button>
            </div>
        </div>

        <div class="test-group">
            <h2>3. Firestore 데이터베이스 검사</h2>
            <div class="test-item">
                <div class="test-item-title">Schedules 읽기 권한</div>
                <div class="test-item-result" id="test-firestore-read">대기중...</div>
            </div>
            <div class="test-item">
                <div class="test-item-title">Schedules 쓰기/삭제 권한</div>
                <div class="test-item-result" id="test-firestore-write">대기중...</div>
            </div>
             <div>
                <button class="btn-info" onclick="testWriteAndDelete()">테스트 데이터 쓰고 지우기</button>
            </div>
        </div>
        
        <div class="test-group">
            <h2>4. 유틸리티 함수 검사</h2>
             <div class="test-item">
                <div class="test-item-title">getTodayKST() (main.js)</div>
                <div class="test-item-result" id="test-util-today">대기중...</div>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.6.7/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.7/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.7/firebase-firestore-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <script src="js/firebase-config.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/main.js"></script>
    <script src="js/dashboard.js"></script>
    <script src="js/admin.js"></script>

    <script>
        // 검사 스크립트 (이전과 동일)
        let testDocId = null;

        function logResult(elementId, message, isSuccess) {
            const el = document.getElementById(elementId);
            const statusClass = isSuccess ? 'pass' : 'fail';
            el.innerHTML = `<span class="status ${statusClass}">${isSuccess ? '성공' : '실패'}</span> ${message}`;
        }
        
        function logInfo(elementId, message) {
            const el = document.getElementById(elementId);
            el.innerHTML = `<span class="status info">정보</span> ${message}`;
        }

        async function runAllTests() {
            // 1. 기본 환경 검사
            logResult('test-firebase-config', 'firebaseConfig 객체가 존재합니다.', typeof firebaseConfig === 'object');
            logResult('test-common-js', 'auth.js의 checkUserLoggedIn 함수가 로드되었습니다.', typeof checkUserLoggedIn === 'function');
            const pageJsLoaded = typeof AdminManager === 'function' && typeof selectDate === 'function';
            logResult('test-page-js', 'admin.js, main.js 등의 페이지 스크립트가 로드되었습니다.', pageJsLoaded);

            // 2. 인증 검사 (상태 표시는 onAuthStateChanged가 처리)
            
            // 3. Firestore 읽기 검사
            try {
                const snapshot = await db.collection('schedules').limit(1).get();
                logResult('test-firestore-read', `데이터를 성공적으로 읽었습니다. (총 ${snapshot.size}개 문서 확인)`, true);
            } catch (error) {
                logResult('test-firestore-read', `읽기 실패: ${error.message}. (보안 규칙 확인 필요)`, false);
            }
            
            // 4. 유틸리티 함수 검사
            try {
                const today = getTodayKST();
                logInfo('test-util-today', `함수 실행 결과: ${today}`);
            } catch (e) {
                 logResult('test-util-today', '함수 실행 실패', false);
            }
        }
        
        async function testLogin() {
            const email = document.getElementById('test-email').value;
            const password = document.getElementById('test-password').value;
            if(!email || !password) {
                alert('테스트할 이메일과 비밀번호를 입력하세요.');
                return;
            }
            try {
                await auth.signInWithEmailAndPassword(email, password);
                alert('테스트 로그인 성공!');
            } catch(e) {
                alert(`테스트 로그인 실패: ${e.message}`);
            }
        }
        
        async function testLogout() {
             try {
                await auth.signOut();
                alert('테스트 로그아웃 성공!');
            } catch(e) {
                alert(`테스트 로그아웃 실패: ${e.message}`);
            }
        }

        async function testWriteAndDelete() {
            const testData = {
                company: "INTEGRITY_TEST_ITEM",
                product: "진단용 임시 데이터",
                date: getTodayKST(),
                start: "01",
                end: "02",
                studio: "스튜디오 소형"
            };
            
            try {
                // 쓰기 테스트
                const docRef = await db.collection('schedules').add(testData);
                testDocId = docRef.id;
                logResult('test-firestore-write', `쓰기 성공 (Test ID: ${testDocId.substring(0,8)}...). 곧 삭제를 시도합니다.`, true);

                // 삭제 테스트 (2초 후)
                setTimeout(async () => {
                    await db.collection('schedules').doc(testDocId).delete();
                    logInfo('test-firestore-write', `임시 데이터 (ID: ${testDocId.substring(0,8)}...) 삭제 성공!`);
                    testDocId = null;
                }, 2000);

            } catch(error) {
                logResult('test-firestore-write', `쓰기/삭제 실패: ${error.message}. (보안 규칙 확인 필요)`, false);
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            auth.onAuthStateChanged(user => {
                if(user) {
                    logInfo('test-auth-status', `로그인 됨 (${user.email})`);
                } else {
                    logInfo('test-auth-status', '로그아웃 상태');
                }
            });
        });

    </script>
</body>
</html>